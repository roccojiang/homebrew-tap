name: Update Iosepta Mono Cask

permissions: {}

on:
  repository_dispatch:
    types: [iosepta-mono-release]

jobs:
  update-cask:
    name: Update cask
    runs-on: ubuntu-slim
    permissions:
      contents: write
      pull-requests: write
    env:
      VERSION: ${{ github.event.client_payload.version }}
    steps:
      - name: Checkout tap
        uses: actions/checkout@v6

      - name: Download and hash release asset
        id: download
        shell: bash
        run: |
          set -euo pipefail
          : "${VERSION:?github.event.client_payload.version does not exist}"

          ASSET="IoseptaMono-SuperTTC-v${VERSION}.zip"
          URL="https://github.com/roccojiang/iosepta-mono/releases/download/v${VERSION}/${ASSET}"

          SHA256=$(
            curl -fsSL "${URL}" |
            shasum -a 256 |
            cut -d' ' -f1
          )

          echo "Downloaded and hashed: ${URL}"
          echo "SHA256: ${SHA256}"

          echo "asset_url=${URL}" >> "$GITHUB_OUTPUT"
          echo "sha256=${SHA256}" >> "$GITHUB_OUTPUT"

      - name: Update cask file
        env:
          CASK_FILE: Casks/font-iosepta-mono.rb
          SHA256: ${{ steps.download.outputs.sha256 }}
        shell: bash
        run: |
          set -euo pipefail

          sed -i \
            -e "s/^  version \".*\"/  version \"${VERSION}\"/" \
            -e "s/^  sha256 \".*\"/  sha256 \"${SHA256}\"/" \
            "$CASK_FILE" 

          echo "Updated cask file:"
          cat "${CASK_FILE}"

      - name: Create cask update PR
        uses: peter-evans/create-pull-request@v8
        with:
          commit-message: "chore: update font-iosepta-mono to v${{ env.VERSION }}"
          branch: update-font-iosepta-mono-${{ env.VERSION }}
          delete-branch: true
          title: "chore: update font-iosepta-mono to v${{ env.VERSION }}"
          body: |
            Automated update for font-iosepta-mono

            **New version:** ${{ env.VERSION }}
            **Release:** https://github.com/roccojiang/iosepta-mono/releases/tag/v${{ env.VERSION }}
            **Asset:** ${{ steps.download.outputs.asset_url }}
            **SHA256:** `${{ steps.download.outputs.sha256 }}`

            ---

            This PR was automatically created in response to a new Iosepta Mono release.
          labels: autoupdate
